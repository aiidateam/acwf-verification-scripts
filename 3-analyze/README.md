# Analyzing the results

In this folder you find scripts to help you analyze your results.

(Note: the folder `eos_utils` is needed by the scripts, you don't need to modify it).

## `get_errors.py`

Run it to store some information on the EOS workchains that failed.
It expects that you already created the file `../plugin_name.txt` (see README file in the folder `1-preliminary` for more details). It will generate a file `outputs/errors-<PLUGIN_NAME>.json` with a summary of UUIDs, exit status, and the `verdi process report` output of the EOS workchains that did not finish with a 0 exit status.

## `get_results.py`

The main script to get results from your calculations.
It expects that you already created the file `../plugin_name.txt` (see README file in the folder `1-preliminary` for more details).

After you run your simulations, just run this script it with `verdi run` and wait.
It will fit all EOS, and create a couple of files in the `outputs` folder, that you can inspect and then share (either by committing those here when they are final, or by copying them in the shared Google Drive).
In particular, it will create:
- `results-<PLUGIN_NAME>.json` with all energy-vs-volume datapoints and the Birch-Murnaghan fit for each material
- `results-warnings-<PLUGIN_NAME>.txt` with some textual information on warnings (the same that are also printed on screen when running the `get_results.py` script).

## `get_results_monoelemental.py`

The same a `get_results.py`, but for the monoelemental systems. The output files are similarly named, but start with `monoelemental-results-` instead of `results-`.

## Generating the plots
In the `outputs` folder you will find a file `generate_plots.py`. Just run it to create a number of PNG plots of the systems you have run. These PNGs will be stored in a subfolder `plots-<PLUGIN_NAME>`, and each PNG will contain the data points and the fit, if successful, for those systems where the EOS workchains succeeded and generated the EOS energy-vs-volume points.

If you want to generate comparison plots of your code with one of the other codes, you can then instead pass an additional parameter to the `generate_plots.py` with the code you want to compare with (i.e. `./generate_plots.py <OTHER_PLUGIN>`, where `<OTHER_PLUGIN>` is e.g. `quantum_espresso`, `cottenier-wien2k`, ...). NOTE: You need to first put the corresponding `results-warnings-<PLUGIN_NAME>.txt` in the same folder.
These PNGs will be stored in a subfolder `plots-<PLUGIN_NAME>-vs-<OTHER_PLUGIN>`. The PNGs will be very similar to those without comparison, but in addition (where available) the fit of the other plugin will be shown, as well as a red region highlighting the difference in EOS between the two plugins.

If you want to plot the results of several plugins without a reference, you can use the `generate_many.py` script. The plugin names (whose
`results-<PLUGIN_NAME>` must be present in the folder) should be all passed as parameter to the script.
For instance `./generate_many.py siesta quantum_espresso cottenier-wien2k` will generate plots reporting (in the same figure) the results
for `siesta`, `quantum_espresso` and `cottenier-wien2k` given that the files `results-siesta` `results-quantum_espresso` and 
`results-cottenier-wien2k` are present in the folder.
The plots graphs will be gathered in the `plot-many` folder.

## Generating heatmaps with delta comparison
In the `outputs` folder you will find a file `generate_deltas.py` that can be used to generate heatmaps that visualize the code VS code comparison based on the delta value.
To obtain them, just run `runanida generate_deltas.py` followed by the list of plugin names you want to consider for the comparison. For instance `runaiida generate_deltas.py siesta quantum_espresso cottenier-wien2k`.
A png picture with the heatmap will be produced for each material and stored in the `deltas` folder with appropriate name.

## Interactively inspecting the plots
In the `outputs` folder you will also find a `show-plots-GUI.ipynb` jupyter notebook.
You can use it to compare quickly plots for different materials and codes.
You need to start jupyter from the same folder. The notebook best works if run with [appmode](https://github.com/oschuett/appmode).
There are a few dependencies to install, mentioned at the top of the notebook itself.

## Creating a single collated PDF
If you want to create a single PDF from all PNG plots, to inspect graphically the results do the following:

- go in the folder `collate-plots`
- run the `create_latex_file.py`:
  - if you want to collate the plots of your plugin only, just run `create_latex_file.py`
  - if you want to collate the plots of your plugin compared with another plugin `<OTHER_PLUGIN>`, specify the name of the other plugin as a parameter: `create_latex_file.py <OTHER_PLUGIN>` (you need, of course, to have generated the right plots in the previous step).
  - if you want to collate the plots generated by `generate_many.py` script (see above), put "many" as first and only argument of `create_latex_file.py`
- enter the `tex-template` subfolder
- run `pdflatex results.tex`
- inspect the output `results.pdf`, possibly rename it appropriately (with your plugin name and possibly the plugin you are comparing with) and share it on the Google Drive.

## Generating histograms with comparison
In the `outputs` folder you will find a file `generate_histos.py` that can be used to generate histograms that visualize the 
distribution of a quantity that compares the plugin with one or more codes.
Just run `runanida generate_histos.py QUANTITY` followed by the list of plugin names you want to compare with your plugin. 
For instance `runaiida generate_histos.py rel_deiff_V0 quantum_espresso`.
Few quantities are now supported, do `runaiida generate_histos.py` to see them.
A png picture with the histogram is produced and put in the folder where the script is run.
It is suggested to not compare with more than 3 plugins since the histograms are all on the same plot.

## Generating (very approximate and preliminary) convex hulls

In order to generate a convex hull, first call the `outputs/compute_convex_hull.py` that will compute the various
energy differences, the convex hull (with only the systems of this study) and generate a JSON file in
`outputs/convex-hulls/convex-hull-data-<PLUGIN_NAME>.json`.

You can then plot it using the script `plot_convex_hull.py` (the output files are also stored, properly
named, in the `outputs/convex-hulls` folder).

**NOTE**: The convex hulls so generated are just a very rough approximation. First of all, they only include the 6 oxides and 2 endpoints (that might not be the lowest-energy ones). In addition, they include no correction, first of all for oxygen, but also not for the various oxygen configurations (see e.g. how the Materials Project applies corrections [here](https://docs.materialsproject.org/methodology/total-energies/#anion-corrections) instead, and the related references).

Therefore, these (and the energy above Hull) should **not** be considered as accurate values.
Instead, what we will be interested in comparing is the *difference* between these plots between pair of codes (where most if not all of these corrections cancel out) - e.g. how different is the formation energy between two given compounds computed by two different codes. So, the Hull plots should just be considered as a check or benchmark that the routines are working correctly and not used for their values.
